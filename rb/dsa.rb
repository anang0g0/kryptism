#! /usr/local/bin/ruby
# /root/ruby-1.6.7/sample/dsa.rb
# Created: April 2,2003
# Author: tcshacina
# $Id: dsa.rb,v 0.9 2003/04/02
# usage: ruby dsa.rb [file]
# hint: Digital Signatures Based on the Discrete Logarithm Problem from Switzerland & RFC2409

def M32(x) (((1 << 32)-1)&(x)) end

@s_r=0
@s_s=0
@a_r=0
@a_s=0
@Pub_key=0
@KEYDEF=0
@KEYDEF2=0
@GROUP_GENERATOR=0
@K=0

class String
  def sha1hex
    SHA1.new(self).hexdigest
  end
end

# close ‚µ‚½‚¢‚¾‚¯ close ‚µ‚È‚­‚Ä‚à‚¢‚¢‚©‚È
# File.open(filename).read ‚Å‘ã—p‰»
def fileread(file)
  f = File.open(file)
  str = f.read
  f.close
  str
end

def usage
  STDERR.puts "usage: #{$0} [OPTION] [FILE]...
  -t, -v      check SHA1 sums against given list
      --status     do not output anything, status code shows success"
  exit 1
end

opt_check = false
opt_status = false

while ARGV[0] =~ /^-/
  $_ = ARGV.shift
  if ~/^-c/ or ~/^--check/
    opt_check = true
  elsif ~/^--status/
    opt_status = true
  else
    usage
  end
end

if opt_status == true and opt_check == false
  STDERR.puts "#{$0}: the --status option is meaningful only when verifying checksums(--check)"
  exit 1
end

require 'sha1'

if opt_check
  ck_count_total = 0
  ck_count_failed = 0
end

while file_str = gets(nil)
  if opt_check
    file_str.split("\n").each do |l|
      ck_count_total += 1
      sum1, fname = l.split
      sum2 = fileread(fname).shahex
      status = if sum1 == sum2
                 'OK'
               else
                 ck_count_failed += 1
                 'FAILED'
               end
      if opt_status
      else
        puts fname + ': ' + status
      end
    end
  else
    puts file_str.sha1hex + '  ' + ARGF.filename
    STATUS= file_str.sha1hex
  end
end

if opt_check and ck_count_failed > 0
  if opt_status
  else
    STDERR.puts "#{$0}: WARNING: #{ck_count_failed} of #{ck_count_total} computed checksum did NOT match"
  end
  exit 1
end


#from RFC2409
#dsa.rb Ruby version
#@GROUP_GENERATOR=2

# Default modulus value by zebedee
@DFLT_MODULUS=0xf488fd584e49dbcd20b49de49107366b336c380d451d0f7c88b31c7c5b2d8ef6f3c923c043f0a55b188d8ebb558cb85d38d334fd7c175743a31d186cde33212cb52aff3ce1b1294018118d7c84a70a72d686c40319c807297aca950cd9969fabd00a509b0246d3083d66a45d419f9c7cbd894b221926baaba25ec355e92f78c7


=begin
#...If you want to abandon man-in-the-middle-attack you must exchange
#a Public key with it's own signature on DH key exchange.
#Here is a signature method NR & DSA with blind.
=end


# GCD
def gcd(xx, yy)
  
  while (yy != 0) 
    tt = xx % yy
    xx = yy
    yy = tt
  end

  return xx

end


# invert of integer
def inv(a, n)
  
  d = n
  x = 0
  s = 1
  while (a != 0)
    q = d / a
    r = d % a
    d = a
    a = r
    t = x - q * s
    x = s
    s = t
  end
  gcd = d  # $\gcd(a, n)$ 

  return ((x + n) % (n / d))
end


#jj=aa^bb mod oo
def exp(aa, bb, oo)

  ii=oo
  j=0
  jj=0
  kk=[2**12] #prime is 4096 bit table
  c=[2**13]  #mod is 8192 bit table
  count=0

  for i in 0..4096
    kk[i]=0
  end
  while(ii>0)
	ii = (ii>>1)
	j=j+1
  end


  kk[0]=aa

#  print j,"\n"
  
#ex.1000=2**3+2**5+2**6+2**7+2**8+2**9 makes a array c=[3,5,6,7,8,9]
    for i in 0..j
      if (((bb^(1<<i))>>i)%2 == 0) # testbit(bb,i)
	c[count]=i
	count=count+1
      end
    end
#    print count,"\n"

    for i in 1..(c[count-1]+1)
      kk[i] = kk[i-1]*kk[i-1]%oo
    end

    jj=1
    for i in 0..count-1
      jj=kk[c[i]]*jj%oo
      if (jj==0)
#	print i,"\n"
      end
    end

    return jj
end


# p>q=(p-1)/2 
def dsa(m, s56)

  #k is select atrandom
  if((@KEYDEF-1)%@K==0)
    print "bad k\n"
    exit()
  end
  rr=exp(@GROUP_GENERATOR,@K,@KEYDEF)
  @a_r = rr % @KEYDEF2
  print "r=", @a_r,"\n"
  @a_s=(@K*m+s56*@a_r)%@KEYDEF2;
  print "s=", @a_s,"\n"

end


# verify DSA signature
def vera(a_r, a_s, m)

  #  m=sha(argc,argv);
  tt=exp(@GROUP_GENERATOR,@a_s,@KEYDEF) # g^{(km+xr)%mod}=g^km*g^xr
  q=exp(@Pub_key,@a_r,@KEYDEF) # g^{r*x}
  q=inv(q,@KEYDEF) # g^{-xr}
  tt=tt*q%@KEYDEF # g^{(km+xr)%mod-xr}
  m=inv(m,@KEYDEF2)
  tt=exp(tt,m,@KEYDEF) # g^k
  v=tt%@KEYDEF2

  if(@a_r!=v)
    print "baka\n"
  end
  if(@a_r==v)
    print "That's True!\n"
  end
end


# message recovery signature
def nr(x, m)

 # select random
  k=108765490876958746235423%@KEYDEF2
  r=m*exp(@GROUP_GENERATOR,k,@KEYDEF)%@KEYDEF
  print "NR-Signature is r=" ,r ,"\n"
  s=(x*r+k)%@KEYDEF2;
  print "s=",s ,"\n"
  @s_r=r;
  @s_s=s;

#  return S;
end


def vnr(s_r, s_s, m)

  y=inv(exp(@GROUP_GENERATOR,@s_s,@KEYDEF),@KEYDEF)
  #  cout << "y=" << Itoa(y,16) << endl;
  ee=exp(@Pub_key,@s_r,@KEYDEF)
  #  cout << "E=" << E << endl;
  mm=y*ee*@s_r%@KEYDEF;

  if(m==mm)
    print "That's True!\n"
  end
end


def elgamal(mm, hh, mod)

  r=888888

  cc=exp(@GROUP_GENERATOR,r,mod)
  dd=exp(hh,r,mod)*mm
  @Cyp_cc=cc
  @Cyp_dd=dd
#  print "(",cc,"," , dd , ")" ,"\n"

end

#cyphertext to plaintext
def decode(cc, dd, x, mod)

  plain=dd*inv(exp(cc,x,mod),mod)%mod

  return plain

end


def main(u)
 
# decide keysize n
  n=1024
  print "n=",n,"\n"

 if (n != 768 && n!= 1024 && n!=1536 && n!=2048 && n!=3072 && n!=4096 && n!=6144 && n != 8192)
   print "You can select from next parametors 768,1024,1536,2048\n"
   print "3072 4096 6144 8192. First [./dsa file] Next you need to input\n"
   print "one of these dsa key size.\n"
   print "Note this version's signature is not secure because of \n"
 end
 if (n==768)
 xx=1552518092300708935130918131258481755631334049434514313202351194902966239949102107258669453876591642442910007680288864229150803718918046342632727613031282983744380820890196288509170691316593175367469551763119843371637221007210577919
 end

 if (n==1024)
 xx=179769313486231590770839156793787453197860296048756011706444423684197180216158519368947833795864925541502180565485980503646440548199239100050792877003355816639229553136239076508735759914822574862575007425302077447712589550957937778424442426617334727629299387668709205606050270810842907692932019128194467627007
 end

# 1536-bitMODPGroup
 if (n==1536)
 xx=2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919
   end

# 2048-bitMODPGroup
 if (n==2048)
xx=32317006071311007300338913926423828248817941241140239112842009751400741706634354222619689417363569347117901737909704191754605873209195028853758986185622153212175412514901774520270235796078236248884246189477587641105928646099411723245426622522193230540919037680524235519125679715870117001058055877651038861847280257976054903569732561526167081339361799541336476559160368317896729073178384589680639671900977202194168647225871031411336429319536193471636533209717077448227988588565369208645296636077250268955505928362751121174096972998068410554359584866583291642136218231078990999448652468262416972035911852507045361090559
   end

# 3072-bitMODPGroup
 if (n==3072)
 xx=5809605995369958062791915965639201402176612226902900533702900882779736177890990861472094774477339581147373410185646378328043729800750470098210924487866935059164371588168047540943981644516632755067501626434556398193186628990071248660819361205119793693985433297036118232914410171876807536457391277857011849897410207519105333355801121109356897459426271845471397952675959440793493071628394122780510124618488232602464649876850458861245784240929258426287699705312584509625419513463605155428017165714465363094021609290561084025893662561222573202082865797821865270991145082200656978177192827024538990239969175546190770645685893438011714430426409338676314743571154537142031573004276428701433036381801705308659830751190352946025482059931306571004727362479688415574702596946457770284148435989129632853918392117997472632693078113129886487399347796982772784615865232621289656944284216824611318709764535152507354116344703769998514148343807
   end

# 4096-bitMODPGroup 
 if (n==4096)
 xx=1044388881413152506679602719846529545831269060992135009022588756444338172022322690710444046669809783930111585737890362691860127079270495454517218673016928427459146001866885779762982229321192368303346235204368051010309155674155697460347176946394076535157284994895284821633700921811716738972451834979455897010306333468590751358365138782250372269117968985194322444535687415522007151638638141456178420621277822674995027990278673458629544391736919766299005511505446177668154446234882665961680796576903199116089347634947187778906528008004756692571666922964122566174582776707332452371001272163776841229318324903125740713574141005124561965913888899753461735347970011693256316751660678950830027510255804846105583465055446615090444309583050775808509297040039680057435342253926566240898195863631588888936364129920059308455669454034010391478238784189888594672336242763795138176353222845524644040094258962433613354036104643881925238489224010194193088911666165584229424668165441688927790460608264864204237717002054744337988941974661214699689706521543006262604535890998125752275942608772174376107314217749233048217904944409836238235772306749874396760463376480215133461333478395682746608242585133953883882226786118030184028136755970045385534758453247
   end

# 7.  6144-bit MODP Group 
 if (n==6144)
 xx=33751521821438561184518523159967412330064897805741846548173890474429429901326672445203235101919165483964194359460994881062089387893762814044257438204432573941083014827006090258925875161018096327732335800595831915976014208822304007327848132734933297885803213675261564962603340457220776826322500058091310967253976619973988033663666385188155212656268079501726223369693427999804134467810120772356498596945532366527400517575471969335854905274504119509592366013711954148258884879224599915203456315881034776553083676995718335598586395591169999570824515035017543533352697525287753332500527176569576894926734950469293596134095086603716860086302051544539652689091299099784588919052383463057789440565460681441902442399956419060521629604697347879024654313800186078316526964529288062740879011035175920059192178561473199006205896719435014765345518490882366607110905303449152556221163232127426440691921134648766635695850239231304591744215610985029636895406718880766308249227315984267542266259489684372223916445411015900506239419267909716320331208988978180868987431623710347617992356201449023892203230133009421463914291201346063125219636964261683591541014344239275340735690997732222069758773963390876360546515755280517042160525487302898122311669799679447530453600399342697032714458549591285939453949034981248114322322367238645042515984447890788917823576330019151696568654314153058547592091366014550143819685170068343700104677609041166369760080933413605498962382077778845599834907475953430787446201384567328530675275792962354883770806900827183685718353469574731680520621944540947734619035177180057973022652571032196598229259194875709994709721793154158686515748507274224181316948797104601068212015232921691482496346854413698719750190601102705274481050543239815130686073601076304512284549218459846046082253596762433827419060089029417044871218316020923109988915707117567
   end

#This prime is: 2^6144 - 2^6080 - 1 + 2^64 * { [2^6014 pi] + 929484 end
#Its hexadecimal value is
#The generator is: 2.


#  8192-bit MODP Group 
 if (n==8192)
  xx=1090748135619415929450294929359784500348155124953172211774101106966150168922785639028532473848836817769712164169076432969224698752674677662739994265785437233596157045970922338040698100507861033047312331823982435279475700199860971612732540528796554502867919746776983759391475987142521315878719577519148811830879919426939958487087540965716419167467499326156226529675209172277001377591248147563782880558861083327174154014975134893125116015776318890295960698011614157721282527539468816519319333337503114777192360412281721018955834377615480468479252748867320362385355596601795122806756217713579819870634321561907813255153703950795271232652404894983869492174481652303803498881366210508647263668376514131031102336837488999775744046733651827239395353540348414872854639719294694323450186884189822544540647226987292160693184734654941906936646576130260972193280317171696418971553954161446191759093719524951116705577362073481319296041201283516154269044389257727700289684119460283480452306204130024913879981135908026983868205969318167819680850998649694416907952712904962404937775789698917207356355227455066183815847669135530549755439819480321732925869069136146085326382334628745456398071603058051634209386708703306545903199608523824513729625136659128221100967735450519952404248198262813831097374261650380017277916975324134846574681307337017380830353680623216336949471306191686438249305686413380231046096450953594089375540285037292470929395114028305547452584962074309438151825437902976012891749355198678420603722034900311364893046495761404333938686140037848030916292543273684533640032637639100774502371542479302473698388692892420946478947733800387782741417786484770190108867879778991633218628640533982619322466154883011452291890252336487236086654396093853898628805813177559162076363154436494477507871294119841637867701722166609831201845484078070518041336869808398454625586921201308185638888082699408686536045192649569198110353659943111802300636106509865023943661829436426563007917282050894429388841748885398290707743052973605359277515749619730823773215894755121761467887865327707115573804264519206349215850195195364813387526811742474131549802130246506341207020335797706780705406945275438806265978516209706795702579244075380490231741030862614968783306207869687868108423639971983209077624758080499988275591392787267627182442892809646874228263172435642368588260139161962836121481966092745325488641054238839295138992979335446110090325230955276870524611359124918392740353154294858383359
   end

# default: print "Choose your key size","\n"

#This prime is: 2^8192 - 2^8128 - 1 + 2^64 * { [2^8062 pi] + 4743158 end
#Its hexadecimal value is
#The generator is: 2.


 #@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041025544008790901161520035530940963382832098363453248929
#@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041025679098587842607769880130803257635362098004642676067
#@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041026219457775608392769258530252434645482096569400384619
#@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041027399552553487693342613655486269495169449756802276859
#@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041027450793510948241920140917503001797853242724149990601
#@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041028084318075915024333205247891692085580137593176269593
 #@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041028130900764515523040048213361448724383585745310554813
 #@KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041028633993801400909073952240434820423460825788360835189
 @KEYDEF=101459693097608319042758415833807677670847628544715540724500026735349301068515392099767184641851031376113522183648115338953972239406909609350543459251533166139494901562515248706419170211273185584865994044063658192209029166200554581462882695234974056443041028708526103161707004900985186431045546342831775691541
 # diviser */
 @KEYDEF2=776378143341645114049424495943980057469202238087

 # SGP */
 # KEYDEF=97788888745463540643262548300201729806525391476402282848706169459770396492073602039095514523473374359988681947091292005523954797054767192116656100785666440095118928776457296943893523018715336260541244217091990481817677778985476605556762672349505655657810698817901064639971684815509507764394425018715419966376587",10);
 #   KEYDEF=97788888745463540643262548300201729806525391476402282848706169459770396492073602039095514523473374359988681947091292005523954797054767192116656100785666440095118928776457296943893523018715336260541244217091990481817677778985476605556762672349505655657810698817901064639971684815509507764394425018715419966382467
 #    KEYDEF2=(KEYDEF-1)/2;

  # choose random secret keys (larger than s56-bit)
  s56=72057593970819135
  s64=9223389611877711887

  s128=340282055605427970793192457633571187455
  s168=373779281620604392915322569464050882390986703503105

  gay=3618502788666131106986593281527206111185510860325500770110842981586944655359

# k is secret number which is sender choosed atrandom
  @K=22387645283764583276458327645823764528376458327645832764528376452837645238764528376453287645


=begin
 @KEYDEF=X;
 @KEYDEF2=(X-1)/2;
=end
 @GROUP_GENERATOR=exp(s56,(@KEYDEF-1)/@KEYDEF2,@KEYDEF)
    if((@KEYDEF-1)%@KEYDEF2!=0)
      exit()
    end
  yy= exp(@GROUP_GENERATOR,s56,@KEYDEF) #Public Key
  @Pub_key=yy
#  e = sha1(argc,argv);
  e= ("0x"+STATUS).hex

  print ARGF.filename , "'s DSA Signature is "
  dsa(e,s56)
  vera(@a_r,@a_s,e)

  nr(s56,e)
  vnr(@s_r,@s_s,e)

end


#e=DFLT_MODULUS*DFLT_MODULUS
#print "e=", e, "\n"

main(ARGV[0].to_i)
